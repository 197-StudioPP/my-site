<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Engineering Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="core.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Prompt',sans-serif;background-color:#f8fafc; user-select: none;}
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }
        
        /* Canvas */
        .editor-container { position: relative; background: white; overflow: hidden; display: flex; flex-direction: column; cursor: text; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
        .editor-content { outline: none; flex: 1; padding: 2rem; overflow-y: auto; z-index: 1; min-height: 500px; position: relative; }
        
        /* Objects */
        .canvas-obj { display: inline-block; position: relative; cursor: pointer; z-index: 10; max-width: 100%; transition: outline 0.1s; vertical-align: bottom; }
        .canvas-obj:hover { outline: 2px dashed #60a5fa; }
        .canvas-obj.selected { outline: 3px solid #2563eb; z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .canvas-obj.absolute-mode { position: absolute; cursor: move; }
        .canvas-obj.absolute-mode:active { cursor: grabbing; }

        /* Shapes */
        .shape-rect { width: 100px; height: 100px; background: rgba(239,68,68,0.1); border: 3px solid #ef4444; }
        .shape-circle { width: 100px; height: 100px; background: rgba(59,130,246,0.1); border: 3px solid #3b82f6; border-radius: 50%; }
        .shape-arrow { width: 100px; height: 6px; background: #10b981; position: relative; margin: 10px 0; }
        .shape-arrow::after { content:''; position: absolute; right: -4px; top: -7px; border-left: 10px solid #10b981; border-top: 10px solid transparent; border-bottom: 10px solid transparent; }

        /* Resize Handle */
        .resize-handle { width: 12px; height: 12px; background: white; border: 2px solid #2563eb; border-radius: 50%; position: absolute; bottom: -6px; right: -6px; cursor: nwse-resize; z-index: 30; display: none; }
        .canvas-obj.selected .resize-handle { display: block; }

        .toolbar-btn { @apply p-2 rounded hover:bg-gray-100 text-gray-600 border border-transparent transition-all; }
        .toolbar-btn:active { transform: scale(0.95); }
        .toolbar-btn.active { @apply bg-blue-100 text-blue-700 border-blue-300; }
        .toolbar-divider { width: 1px; height: 24px; background-color: #e5e7eb; margin: 0 4px; }
        
        .modal-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw; height: 100vh; max-width: none; border-radius: 0; z-index: 50; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-slate-50">
    <div class="px-4 py-3 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-20 flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-indigo-600 text-white rounded-lg shadow-sm"><i data-lucide="notebook-pen" class="w-5 h-5"></i></div>
            <h2 class="text-lg font-bold text-gray-800">สมุดบันทึก (Engineering Notes)</h2>
        </div>
        <div class="flex gap-2 items-center">
            <div class="relative group">
                <i data-lucide="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400"></i>
                <input type="text" placeholder="ค้นหา..." class="pl-8 pr-3 py-1.5 border rounded text-xs outline-none focus:border-indigo-500 w-48 transition-all" oninput="NotesModule.actions.search(this.value)">
            </div>
            <button onclick="NotesModule.actions.openNoteForm()" class="bg-indigo-600 text-white px-4 py-1.5 rounded flex items-center gap-1.5 hover:bg-indigo-700 shadow-md text-xs font-bold">
                <i data-lucide="plus" class="w-4 h-4"></i> สร้างใหม่
            </button>
        </div>
    </div>

    <div id="content-container" class="flex-1 overflow-y-auto p-4 bg-slate-50"></div>
    <div id="modal-root" class="fixed inset-0 z-50 pointer-events-none"></div>
    <div id="confirm-modal-root" class="fixed inset-0 z-[60] pointer-events-none"></div>

    <script>
        if (typeof window.Core === 'undefined') {
            window.Core = {
                Storage: { get: (k, d) => JSON.parse(localStorage.getItem(k)) || d, set: (k, v) => localStorage.setItem(k, JSON.stringify(v)) }
            };
        }

        let activeObj = null, isDragging = false, isResizing = false;
        let startX, startY, startLeft, startTop, startW, startH;

        const NotesModule = {
            state: { 
                notes: window.Core.Storage.get('myNotes', []), 
                searchQuery: '',
                noteForm: { isOpen: false, data: null, isFullScreen: false },
                confirm: { isOpen: false, title: '', message: '', callback: null }
            },

            init() { this.render(); this.setupGlobalListeners(); },
            save() { window.Core.Storage.set('myNotes', this.state.notes); this.render(); },

            actions: {
                search(q) { NotesModule.state.searchQuery = q.toLowerCase(); NotesModule.render(); },
                
                confirmAction(title, message, callback) {
                    NotesModule.state.confirm = { isOpen: true, title, message, callback };
                    NotesModule.renderModal();
                },
                confirmYes() {
                    if(NotesModule.state.confirm.callback) NotesModule.state.confirm.callback();
                    NotesModule.actions.closeConfirm();
                },
                closeConfirm() {
                    NotesModule.state.confirm = { isOpen: false, title: '', message: '', callback: null };
                    NotesModule.renderModal();
                },

                openNoteForm(id=null) {
                    const note = id ? NotesModule.state.notes.find(n=>n.id==id) : {title:'', content:'', tags:''};
                    NotesModule.state.noteForm = {isOpen:true, data:{...note}, isEdit:!!id, id:id||Date.now(), isFullScreen:false};
                    NotesModule.renderModal();
                    setTimeout(() => NotesModule.setupEditor(), 100);
                },
                saveNoteForm() {
                    const d = NotesModule.state.noteForm.data;
                    const editor = document.getElementById('richEditor');
                    if(editor) {
                        const clones = editor.cloneNode(true);
                        clones.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                        clones.querySelectorAll('.resize-handle').forEach(el => el.remove());
                        d.content = clones.innerHTML;
                    }
                    if(!d.title) return alert('กรุณาใส่หัวข้อ');
                    const note = { id: NotesModule.state.noteForm.id, title: d.title, content: d.content, tags: d.tags, updated: Date.now() };
                    
                    if(NotesModule.state.noteForm.isEdit) {
                        const idx = NotesModule.state.notes.findIndex(n=>n.id==note.id);
                        if(idx > -1) NotesModule.state.notes[idx] = note;
                    } else { NotesModule.state.notes.unshift(note); }
                    NotesModule.state.noteForm.isOpen = false;
                    NotesModule.save();
                },
                deleteNote(id) {
                    NotesModule.actions.confirmAction('ลบบันทึก', 'ยืนยันการลบ? ข้อมูลจะหายไปถาวร', () => {
                        NotesModule.state.notes = NotesModule.state.notes.filter(n=>n.id!=id);
                        NotesModule.actions.closeForms();
                        NotesModule.save();
                    });
                },

                execCmd(cmd) { document.execCommand(cmd, false, null); },
                addImage(input) {
                    if(input.files[0]) {
                        const r = new FileReader();
                        r.onload = e => {
                            const html = `<img src="${e.target.result}" class="canvas-obj" style="max-width:300px;">`;
                            document.execCommand('insertHTML', false, html);
                            NotesModule.setupEditor();
                        };
                        r.readAsDataURL(input.files[0]);
                    }
                },
                addShape(type) {
                    let html = '';
                    if(type==='rect') html = `<div class="canvas-obj shape-rect" contenteditable="false"></div>`;
                    if(type==='circle') html = `<div class="canvas-obj shape-circle" contenteditable="false"></div>`;
                    if(type==='arrow') html = `<div class="canvas-obj shape-arrow" contenteditable="false"></div>`;
                    document.execCommand('insertHTML', false, html + '&nbsp;');
                    NotesModule.setupEditor();
                },
                
                selectObject(el) {
                    if(activeObj) this.deselectObject();
                    activeObj = el;
                    activeObj.classList.add('selected');
                    if(!activeObj.querySelector('.resize-handle')) {
                        const handle = document.createElement('div');
                        handle.className = 'resize-handle';
                        handle.contentEditable = false;
                        activeObj.appendChild(handle);
                    }
                    const btnFree = document.getElementById('btn-free');
                    const btnDel = document.getElementById('btn-del');
                    if(btnFree) {
                        btnFree.disabled = false;
                        btnFree.classList.toggle('active', activeObj.classList.contains('absolute-mode'));
                    }
                    if(btnDel) btnDel.disabled = false;
                },
                deselectObject() {
                    if(activeObj) {
                        activeObj.classList.remove('selected');
                        const h = activeObj.querySelector('.resize-handle');
                        if(h) h.remove();
                        activeObj = null;
                    }
                    const btnFree = document.getElementById('btn-free');
                    const btnDel = document.getElementById('btn-del');
                    if(btnFree) { btnFree.disabled = true; btnFree.classList.remove('active'); }
                    if(btnDel) btnDel.disabled = true;
                },
                toggleFreeMove() {
                    if(!activeObj) return;
                    const isAbs = activeObj.classList.contains('absolute-mode');
                    if(!isAbs) {
                        activeObj.classList.add('absolute-mode');
                        activeObj.style.position = 'absolute';
                        const editor = document.getElementById('richEditor');
                        activeObj.style.left = (editor.scrollLeft + 50) + 'px';
                        activeObj.style.top = (editor.scrollTop + 50) + 'px';
                    } else {
                        activeObj.classList.remove('absolute-mode');
                        activeObj.style.position = '';
                    }
                    document.getElementById('btn-free').classList.toggle('active');
                },
                deleteObject() {
                    if(activeObj) { activeObj.remove(); NotesModule.actions.deselectObject(); }
                },
                
                closeForms() { 
                    NotesModule.state.noteForm.isOpen = false;
                    this.deselectObject();
                    NotesModule.render();
                },
                toggleFullScreen() { 
                    NotesModule.state.noteForm.isFullScreen = !NotesModule.state.noteForm.isFullScreen; 
                    NotesModule.renderModal(); 
                    setTimeout(() => NotesModule.setupEditor(), 100);
                }
            },

            setupGlobalListeners() {
                document.addEventListener('pointermove', e => {
                    if(isDragging && activeObj && activeObj.classList.contains('absolute-mode')) {
                        e.preventDefault();
                        activeObj.style.left = `${startLeft + (e.clientX - startX)}px`;
                        activeObj.style.top = `${startTop + (e.clientY - startY)}px`;
                    }
                    if(isResizing && activeObj) {
                        e.preventDefault();
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        activeObj.style.width = `${startW + dx}px`;
                        activeObj.style.height = `${startH + dy}px`;
                    }
                });
                document.addEventListener('pointerup', () => { isDragging = false; isResizing = false; });
                document.addEventListener('keydown', e => {
                    if((e.key === 'Delete' || e.key === 'Backspace') && activeObj) {
                        e.preventDefault();
                        NotesModule.actions.deleteObject();
                    }
                });
            },

            setupEditor() {
                const editor = document.getElementById('richEditor');
                if(!editor) return;
                editor.addEventListener('pointerdown', e => {
                    if(e.target.classList.contains('resize-handle')) {
                        e.stopPropagation(); isResizing = true;
                        startX = e.clientX; startY = e.clientY;
                        startW = activeObj.offsetWidth; startH = activeObj.offsetHeight;
                        return;
                    }
                    const target = e.target.closest('.canvas-obj') || (e.target.tagName === 'IMG' ? e.target : null);
                    if(target) {
                        e.stopPropagation();
                        NotesModule.actions.selectObject(target);
                        if(target.classList.contains('absolute-mode')) {
                            isDragging = true; startX = e.clientX; startY = e.clientY;
                            startLeft = target.offsetLeft; startTop = target.offsetTop;
                            try{target.setPointerCapture(e.pointerId)}catch(err){}
                            e.preventDefault();
                        }
                    } else { NotesModule.actions.deselectObject(); }
                });
            },

            render() {
                const container = document.getElementById('content-container');
                let items = this.state.notes;
                if(this.state.searchQuery) items = items.filter(n => n.title.toLowerCase().includes(this.state.searchQuery));
                
                if(items.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 mt-10">ไม่มีบันทึก</div>`; return; }
                
                container.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">` + items.map(n => `
                    <div class="bg-white p-4 rounded-xl border hover:shadow-lg cursor-pointer h-48 flex flex-col group relative transition-all" onclick="NotesModule.actions.openNoteForm(${n.id})">
                        <h3 class="font-bold text-gray-800 mb-2 truncate">${n.title}</h3>
                        <div class="flex-1 overflow-hidden text-xs text-gray-400 relative bg-gray-50/50 rounded p-2">
                            <div class="scale-90 origin-top-left pointer-events-none select-none">${n.content}</div>
                            <div class="absolute inset-0 bg-gradient-to-t from-white to-transparent"></div>
                        </div>
                        <div class="mt-2 flex justify-between items-center">
                            <span class="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-full">${n.tags||'ทั่วไป'}</span>
                            <button onclick="event.stopPropagation(); NotesModule.actions.deleteNote(${n.id})" class="p-1 text-red-300 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                `).join('') + `</div>`;
                
                this.renderModal();
                lucide.createIcons();
            },

            renderModal() {
                const root = document.getElementById('modal-root');
                const confirmRoot = document.getElementById('confirm-modal-root');
                
                if(!this.state.confirm.isOpen) { confirmRoot.innerHTML = ''; confirmRoot.className = 'hidden'; }
                if(this.state.confirm.isOpen) {
                    confirmRoot.className = 'fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4 fade-in';
                    confirmRoot.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full fade-in">
                        <h3 class="font-bold text-lg mb-2">${this.state.confirm.title}</h3>
                        <p class="text-gray-600 mb-6 text-sm">${this.state.confirm.message}</p>
                        <div class="flex justify-end gap-2">
                            <button onclick="NotesModule.actions.closeConfirm()" class="px-4 py-2 rounded bg-gray-100 text-gray-600">ยกเลิก</button>
                            <button id="btn-confirm-ok" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">ยืนยัน</button>
                        </div>
                    </div>`;
                    setTimeout(() => { document.getElementById('btn-confirm-ok').onclick = () => NotesModule.actions.confirmYes(); }, 0);
                }

                if(!this.state.noteForm.isOpen) { root.innerHTML = ''; root.className = 'hidden'; return; }
                
                root.className = 'fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 p-0 md:p-4 fade-in';
                const d = this.state.noteForm.data;
                const fs = this.state.noteForm.isFullScreen;
                
                root.innerHTML = `
                    <div class="bg-white ${fs?'fixed inset-0 rounded-none':'rounded-xl max-w-6xl w-full h-full md:h-[90vh]'} flex flex-col shadow-2xl overflow-hidden transition-all fade-in">
                        <div class="p-3 border-b flex items-center justify-between bg-gray-50 flex-shrink-0">
                            <input class="bg-transparent font-bold text-xl outline-none flex-1" placeholder="หัวข้อบันทึก..." value="${d.title}" oninput="NotesModule.state.noteForm.data.title=this.value">
                            <div class="flex gap-2">
                                <button onclick="NotesModule.actions.toggleFullScreen()" class="p-2 text-gray-500 hover:bg-gray-200 rounded"><i data-lucide="${fs?'minimize':'maximize'}" class="w-5 h-5"></i></button>
                                ${this.state.noteForm.isEdit ? `<button onclick="NotesModule.actions.deleteNote(${d.id})" class="p-2 text-red-500 hover:bg-red-50 rounded"><i data-lucide="trash-2"></i></button>` : ''}
                                <button onclick="NotesModule.actions.saveNoteForm()" class="bg-blue-600 text-white px-4 py-2 rounded shadow flex gap-2 items-center"><i data-lucide="save" class="w-4 h-4"></i> บันทึก</button>
                                <button onclick="NotesModule.actions.closeForms()" class="p-2 hover:bg-gray-200 rounded"><i data-lucide="x"></i></button>
                            </div>
                        </div>
                        <div class="p-2 border-b bg-white flex flex-wrap gap-1 items-center shadow-sm z-20 overflow-x-auto">
                            <button onclick="NotesModule.actions.execCmd('bold')" class="toolbar-btn" title="Bold"><i data-lucide="bold" class="w-4 h-4"></i></button>
                            <button onclick="NotesModule.actions.execCmd('italic')" class="toolbar-btn" title="Italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                            <div class="toolbar-divider"></div>
                            <button onclick="NotesModule.actions.addShape('rect')" class="toolbar-btn text-red-500" title="สี่เหลี่ยม"><i data-lucide="square" class="w-4 h-4"></i></button>
                            <button onclick="NotesModule.actions.addShape('circle')" class="toolbar-btn text-blue-500" title="วงกลม"><i data-lucide="circle" class="w-4 h-4"></i></button>
                            <button onclick="NotesModule.actions.addShape('arrow')" class="toolbar-btn text-green-500" title="ลูกศร"><i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                            <label class="toolbar-btn cursor-pointer" title="แทรกรูป"><input type="file" hidden accept="image/*" onchange="NotesModule.actions.addImage(this)"><i data-lucide="image" class="w-4 h-4"></i></label>
                            <div class="toolbar-divider"></div>
                            <button id="btn-free" onclick="NotesModule.actions.toggleFreeMove()" class="toolbar-btn" disabled title="ย้ายอิสระ"><i data-lucide="move" class="w-4 h-4"></i></button>
                            <button id="btn-del" onclick="NotesModule.actions.deleteObject()" class="toolbar-btn hover:text-red-500" disabled title="ลบวัตถุ"><i data-lucide="trash" class="w-4 h-4"></i></button>
                            <input class="ml-auto text-sm border-b outline-none w-32" placeholder="Tags..." value="${d.tags||''}" oninput="NotesModule.state.noteForm.data.tags=this.value">
                        </div>
                        <div class="editor-container flex-1">
                            <div id="richEditor" class="editor-content flex-1 p-8 md:p-12 text-gray-800" contenteditable="true">${d.content}</div>
                        </div>
                    </div>`;
            }
        };

        window.onload = () => NotesModule.init();
    </script>
</body>
</html>