<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="core.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>body{font-family:'Prompt',sans-serif;background-color:#f9fafb;} .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }</style>
</head>
<body class="h-screen flex flex-col p-6 overflow-hidden">
    <!-- Header -->
    <div class="flex justify-between items-end mb-6 flex-shrink-0">
        <div>
            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i data-lucide="folder-kanban" class="w-8 h-8 text-blue-600"></i> คลังไฟล์ (File Manager)
            </h2>
            <p class="text-sm text-gray-500 mt-1">จัดการไฟล์และเอกสารโครงการ</p>
        </div>
        <button onclick="DashboardModule.actions.openGroupForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow flex gap-2 transition-colors">
            <i data-lucide="plus"></i> กลุ่มใหม่
        </button>
    </div>

    <!-- Main Content Grid -->
    <div id="content" class="folder-grid overflow-y-auto pb-10"></div>
    
    <!-- Modal Root -->
    <div id="modal-root" class="fixed inset-0 z-50 pointer-events-none"></div>

    <script>
        const DashboardModule = {
            state: { 
                // Load from 'myFileGroups' based on JSON backup structure
                groups: Core.Storage.get('myFileGroups', []), 
                form: {isOpen:false}, 
                viewer: {isOpen:false, group:null, path:[], activeFile:null} 
            },

            init() { 
                this.render(); 
            },

            save() { 
                Core.Storage.set('myFileGroups', this.state.groups); 
                this.render(); 
            },
            
            // --- Helper to traverse path ---
            getCurrentList() {
                if (!this.state.viewer.group) return [];
                let target = this.state.viewer.group.items;
                for(const folder of this.state.viewer.path) {
                    const found = target.find(x => x.id == folder.id);
                    if (found && found.children) {
                        target = found.children;
                    } else {
                        return []; // Error path
                    }
                }
                return target;
            },

            actions: {
                openGroupForm(id=null) { 
                    const g = id ? this.state.groups.find(x=>x.id==id) : {title:''};
                    this.state.form = {isOpen:true, data:{...g}, isEdit:!!id, id:id||Date.now(), type:'group'};
                    this.renderModal();
                },
                saveGroup() {
                    const d = this.state.form.data;
                    if(!d.title) return alert('กรุณาใส่ชื่อกลุ่ม');
                    
                    if(this.state.form.isEdit) { 
                        const idx=this.state.groups.findIndex(x=>x.id==this.state.form.id); 
                        if(idx > -1) this.state.groups[idx]={...this.state.groups[idx], ...d}; 
                    } else { 
                        // Initialize with items: [] explicitly
                        this.state.groups.push({id:this.state.form.id, title:d.title, items:[], category:'ทั่วไป', ...d}); 
                    }
                    this.state.form.isOpen=false; 
                    this.save(); 
                },
                deleteGroup(id) { 
                    if(confirm('ยืนยันการลบกลุ่มนี้? ข้อมูลภายในจะหายทั้งหมด')) { 
                        this.state.groups = this.state.groups.filter(x=>x.id!=id); 
                        this.save(); 
                    } 
                },
                
                // --- Viewer Actions ---
                openViewer(id) { 
                    const group = this.state.groups.find(x=>x.id==id);
                    if(!group) return;
                    // Reset viewer state
                    this.state.viewer = {isOpen:true, group:group, path:[], activeFile:null}; 
                    this.renderModal(); 
                },
                closeViewer() { 
                    this.state.viewer.isOpen=false; 
                    this.renderModal(); 
                },
                
                // Item (File/Folder) Actions
                openItemForm(type) { 
                    this.state.form = {
                        isOpen:true, 
                        data:{title:'', type:type, sourceType:'file', url:'', fileObj:null, previewObj:null}, 
                        type:'item'
                    };
                    this.renderModal();
                },
                handleFile(input, key) { 
                    if(input.files[0]) { 
                        this.state.form.data[key]=input.files[0]; 
                        // Generate preview for image
                        if(key==='previewObj' || (key==='fileObj' && input.files[0].type.startsWith('image/'))){ 
                            const r=new FileReader(); 
                            r.onload=e=>document.getElementById('preview-img').src=e.target.result; 
                            r.readAsDataURL(input.files[0]); 
                        } 
                    } 
                },
                async saveItem() {
                    const d = this.state.form.data;
                    if(!d.title) return alert('กรุณาใส่ชื่อ');
                    
                    const item = {
                        id: Date.now(), 
                        title: d.title, 
                        type: d.type, // 'folder' or 'file'
                        sourceType: d.sourceType, 
                        url: d.url,
                        children: [] // Important for folders
                    };
                    
                    // Save Blob to IndexedDB if it's a file upload
                    if(d.fileObj || d.previewObj) {
                        const saved = await Core.DB.saveFile(item.id, d.fileObj, d.previewObj);
                        if(!saved) alert("Warning: Failed to save file content to DB");
                    }
                    
                    // Add to current path
                    const target = DashboardModule.getCurrentList();
                    target.push(item);
                    
                    this.state.form.isOpen=false; 
                    this.save(); // Save structure to localStorage
                    this.renderModal(); // Refresh Viewer
                },
                
                enterFolder(id) { 
                    const target = DashboardModule.getCurrentList();
                    const folder = target.find(x=>x.id==id);
                    if(folder && folder.type === 'folder') {
                        if(!folder.children) folder.children = []; // Safety check
                        this.state.viewer.path.push({id: folder.id, title: folder.title});
                        this.state.viewer.activeFile = null;
                        this.renderModal();
                    }
                },
                navUp() { 
                    this.state.viewer.path.pop(); 
                    this.state.viewer.activeFile = null;
                    this.renderModal(); 
                },
                
                async setActiveFile(id) {
                    const target = DashboardModule.getCurrentList();
                    const file = target.find(x=>x.id==id);
                    this.state.viewer.activeFile = file;
                    
                    this.renderModal(); // Update UI to show loading or empty first
                    
                    const pane = document.getElementById('preview-pane');
                    pane.innerHTML = `<div class="flex flex-col items-center"><i data-lucide="loader" class="animate-spin mb-2"></i> Loading...</div>`;
                    lucide.createIcons();

                    // Load Data
                    let previewUrl = null;
                    let fileUrl = null;

                    // 1. Try DB
                    const rec = await Core.DB.getFile(id);
                    if(rec) {
                        if(rec.previewBlob) previewUrl = URL.createObjectURL(rec.previewBlob);
                        if(rec.fileBlob) fileUrl = URL.createObjectURL(rec.fileBlob);
                    }
                    
                    // Render Preview
                    let contentHtml = '';
                    
                    // A. Preview Image
                    if(previewUrl) {
                        contentHtml += `<img src="${previewUrl}" class="max-w-full max-h-96 object-contain mb-4 rounded shadow-sm">`;
                    } else if(file && file.sourceType === 'file' && fileUrl && file.title.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                         // If main file is image
                        contentHtml += `<img src="${fileUrl}" class="max-w-full max-h-96 object-contain mb-4 rounded shadow-sm">`;
                    } else {
                        contentHtml += `<div class="text-gray-400 mb-4"><i data-lucide="file" class="w-16 h-16"></i></div>`;
                    }

                    // B. Info & Actions
                    contentHtml += `<h3 class="font-bold text-lg mb-2">${file.title}</h3>`;
                    
                    if(file.sourceType === 'link') {
                        contentHtml += `<a href="${file.url}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded flex items-center gap-2"><i data-lucide="external-link" class="w-4 h-4"></i> เปิดลิงก์</a>`;
                    } else if (fileUrl) {
                        contentHtml += `<a href="${fileUrl}" download="${file.title}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> ดาวน์โหลด</a>`;
                    } else {
                        contentHtml += `<div class="text-red-500 text-sm">ไม่พบไฟล์ต้นฉบับ (อาจถูกลบหรือไม่ได้บันทึกใน DB)</div>`;
                    }

                    pane.innerHTML = contentHtml;
                    lucide.createIcons();
                },
                deleteItem(id) {
                     if(confirm('ลบรายการนี้?')) {
                        const target = DashboardModule.getCurrentList();
                        const idx = target.findIndex(x=>x.id == id);
                        if(idx > -1) {
                            target.splice(idx, 1);
                            Core.DB.deleteFile(id); // Cleanup DB
                            this.save();
                            this.renderModal();
                        }
                     }
                }
            },
            
            render() {
                const html = this.state.groups.map(g => `
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md cursor-pointer relative group transition-all" onclick="DashboardModule.actions.openViewer(${g.id})">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="p-2 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="package" class="w-6 h-6"></i></div>
                            <h3 class="font-bold text-lg text-gray-800 truncate">${g.title}</h3>
                        </div>
                        <p class="text-sm text-gray-500">${g.items ? g.items.length : 0} รายการ</p>
                        <button onclick="event.stopPropagation();DashboardModule.actions.deleteGroup(${g.id})" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`).join('');
                    
                document.getElementById('content').innerHTML = html || '<div class="col-span-full text-center text-gray-400 mt-10">ยังไม่มีกลุ่มไฟล์</div>';
                this.renderModal();
                lucide.createIcons();
            },
            
            renderModal() {
                const root = document.getElementById('modal-root');
                root.innerHTML = ''; 
                root.className='fixed inset-0 z-50 pointer-events-none';
                
                // --- 1. Form Modal ---
                if(this.state.form.isOpen) {
                    root.className='fixed inset-0 z-50 pointer-events-auto bg-black/60 backdrop-blur-sm flex items-center justify-center';
                    const d = this.state.form.data;
                    
                    if(this.state.form.type === 'group') {
                        root.innerHTML = `
                        <div class="bg-white p-6 rounded-xl w-96 shadow-2xl">
                            <h3 class="font-bold mb-4 text-lg">จัดการกลุ่มไฟล์</h3>
                            <input class="border w-full p-2.5 rounded mb-4 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="ชื่อกลุ่ม..." value="${d.title}" oninput="DashboardModule.state.form.data.title=this.value">
                            <div class="flex gap-2">
                                <button onclick="DashboardModule.state.form.isOpen=false;DashboardModule.renderModal()" class="flex-1 py-2 text-gray-500 hover:bg-gray-100 rounded">ยกเลิก</button>
                                <button onclick="DashboardModule.actions.saveGroup()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 shadow-lg">บันทึก</button>
                            </div>
                        </div>`;
                    } else {
                        // Item Form
                        const isFile = d.sourceType==='file';
                        root.innerHTML = `
                        <div class="bg-white p-6 rounded-xl w-[400px] shadow-2xl">
                            <h3 class="font-bold mb-4 text-lg">เพิ่ม${d.type==='folder'?'โฟลเดอร์':'ไฟล์'}</h3>
                            <input class="border w-full p-2.5 rounded mb-4 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="ชื่อเรียก..." value="${d.title}" oninput="DashboardModule.state.form.data.title=this.value">
                            
                            ${d.type === 'file' ? `
                                <div class="flex gap-4 mb-4 bg-gray-50 p-2 rounded">
                                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="t" ${isFile?'checked':''} onchange="DashboardModule.state.form.data.sourceType='file';DashboardModule.renderModal()"> อัพโหลดไฟล์</label>
                                    <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="t" ${!isFile?'checked':''} onchange="DashboardModule.state.form.data.sourceType='link';DashboardModule.renderModal()"> ลิงก์ URL</label>
                                </div>
                                ${isFile ? `
                                    <div class="mb-4">
                                        <label class="block text-xs font-bold text-gray-500 mb-1">ไฟล์หลัก</label>
                                        <input type="file" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="DashboardModule.actions.handleFile(this,'fileObj')">
                                    </div>
                                ` : `
                                    <input class="border w-full p-2.5 rounded mb-4 text-sm font-mono" placeholder="https://..." value="${d.url}" oninput="DashboardModule.state.form.data.url=this.value">
                                `}
                                <div class="mb-4">
                                    <label class="block text-xs font-bold text-gray-500 mb-1">รูปตัวอย่าง (Optional)</label>
                                    <input type="file" accept="image/*" class="text-xs" onchange="DashboardModule.actions.handleFile(this,'previewObj')">
                                    <img id="preview-img" class="h-20 mt-2 rounded border object-contain bg-gray-50">
                                </div>
                            ` : ''}
                            
                            <div class="flex gap-2 mt-6">
                                <button onclick="DashboardModule.state.form.isOpen=false;DashboardModule.renderModal()" class="flex-1 py-2 text-gray-500 hover:bg-gray-100 rounded">ยกเลิก</button>
                                <button onclick="DashboardModule.actions.saveItem()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700 shadow-lg">บันทึก</button>
                            </div>
                        </div>`;
                    }
                }
                
                // --- 2. Viewer Modal ---
                if(this.state.viewer.isOpen) {
                    root.className='fixed inset-0 z-50 pointer-events-auto bg-slate-900/95 flex items-center justify-center p-4 md:p-8';
                    const list = DashboardModule.getCurrentList();
                    const activeFileId = this.state.viewer.activeFile ? this.state.viewer.activeFile.id : null;
                    
                    root.innerHTML = `
                        <div class="bg-white w-full h-full max-w-6xl rounded-2xl flex flex-col overflow-hidden shadow-2xl">
                            <!-- Viewer Header -->
                            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <h3 class="font-bold text-lg whitespace-nowrap">${this.state.viewer.group.title}</h3>
                                    <div class="flex items-center text-gray-400 text-sm">
                                        ${this.state.viewer.path.map(p=>`<i data-lucide="chevron-right" class="w-4 h-4 mx-1"></i> <span class="font-medium text-gray-600">${p.title}</span>`).join('')}
                                    </div>
                                </div>
                                <button onclick="DashboardModule.actions.closeViewer()" class="p-2 hover:bg-gray-200 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            
                            <!-- Viewer Body -->
                            <div class="flex-1 flex overflow-hidden">
                                <!-- Sidebar List -->
                                <div class="w-1/3 md:w-1/4 border-r bg-white flex flex-col min-w-[250px]">
                                    <div class="p-3 border-b flex gap-2 bg-gray-50/50">
                                        <button onclick="DashboardModule.actions.openItemForm('folder')" class="flex-1 bg-white border hover:bg-gray-50 py-1.5 rounded text-xs font-bold text-gray-700 flex justify-center items-center gap-1"><i data-lucide="folder-plus" class="w-3 h-3"></i> โฟลเดอร์</button>
                                        <button onclick="DashboardModule.actions.openItemForm('file')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-1.5 rounded text-xs font-bold flex justify-center items-center gap-1"><i data-lucide="file-plus" class="w-3 h-3"></i> ไฟล์</button>
                                    </div>
                                    <div class="flex-1 overflow-y-auto p-2 space-y-1">
                                        ${this.state.viewer.path.length>0 ? 
                                            `<button onclick="DashboardModule.actions.navUp()" class="w-full text-left p-2 hover:bg-gray-100 rounded text-sm font-bold text-blue-600 flex items-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> กลับ</button>` : ''}
                                        
                                        ${list.length === 0 ? '<div class="text-center text-gray-400 text-sm py-4">ว่างเปล่า</div>' : ''}
                                        
                                        ${list.map(i => {
                                            const isActive = activeFileId === i.id;
                                            return `
                                            <div class="flex items-center justify-between p-2 rounded cursor-pointer group ${isActive ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-50 text-gray-700'}" 
                                                onclick="${i.type==='folder'?'DashboardModule.actions.enterFolder('+i.id+')':'DashboardModule.actions.setActiveFile('+i.id+')'}">
                                                <div class="flex items-center gap-2 truncate">
                                                    <i data-lucide="${i.type==='folder'?'folder':(i.sourceType==='file'?'file':'link')}" class="w-4 h-4 ${i.type==='folder'?'text-yellow-500':'text-gray-400'}"></i> 
                                                    <span class="text-sm font-medium truncate">${i.title}</span>
                                                </div>
                                                <button onclick="event.stopPropagation();DashboardModule.actions.deleteItem(${i.id})" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                            </div>`;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <!-- Preview Pane -->
                                <div class="flex-1 bg-gray-50 flex items-center justify-center p-8 relative overflow-y-auto" id="preview-pane">
                                    <div class="text-center">
                                        <div class="bg-white p-4 rounded-full inline-block shadow-sm mb-4"><i data-lucide="eye" class="w-8 h-8 text-gray-300"></i></div>
                                        <p class="text-gray-400">เลือกไฟล์เพื่อดูตัวอย่าง</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
            }
        };
        window.onload = () => DashboardModule.init();
    </script>
</body>
</html>