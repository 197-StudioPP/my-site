<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Master v20 (Unlocked)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- EMBEDDED CORE -->
    <script>
    (function () {
        const Core = (window.Core = window.Core || {});
        const bus = new BroadcastChannel('eng_workspace_channel');
        Core.Bus = { emit(e, d) { bus.postMessage({ event: e, data: d }); }, on(e, cb) { bus.addEventListener('message', (ev) => { if (ev.data?.event === e) cb(ev.data.data); }); } };
        Core.Storage = { get(k, d=null) { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } }, set(k, v, n) { localStorage.setItem(k, JSON.stringify(v)); if (n) Core.Bus.emit(n, v); } };
        Core.Util = { generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2), todayISO: () => new Date(new Date().getTime() - (new Date().getTimezoneOffset()*60000)).toISOString().split('T')[0] };
    })();
    </script>

    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; overflow: hidden; }
        .timeline-wrapper { position: relative; width: 100%; height: 100%; overflow: auto; background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; }
        
        /* Sidebar Width */
        :root { --sidebar-width: 300px; --header-height: 90px; }
        
        .sticky-corner { position: sticky; top: 0; left: 0; z-index: 50; background: #f1f5f9; border-right: 1px solid #cbd5e1; border-bottom: 1px solid #cbd5e1; min-width: var(--sidebar-width); max-width: var(--sidebar-width); height: var(--header-height); display: flex; align-items: center; justify-content: center; font-weight: 700; color: #334155; }
        .sticky-header { position: sticky; top: 0; z-index: 40; background: white; border-bottom: 1px solid #cbd5e1; height: var(--header-height); display: flex; }
        
        .sticky-project { position: sticky; left: 0; z-index: 35; background: #f8fafc; border-right: 1px solid #cbd5e1; border-bottom: 1px solid #cbd5e1; min-width: var(--sidebar-width); max-width: var(--sidebar-width); padding: 12px; }
        .sticky-task { position: sticky; left: 0; z-index: 30; background: white; border-right: 1px solid #cbd5e1; border-bottom: 1px solid #f1f5f9; min-width: var(--sidebar-width); max-width: var(--sidebar-width); display: flex; flex-direction: column; justify-content: center; }

        .grid-bg { background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px); background-size: 70px 100%; }
        .grid-ampm { background-image: linear-gradient(to right, transparent 49%, #f1f5f9 1px, transparent 51%); opacity: 1; }
        .remark-tag { font-size: 0.7rem; background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; margin-top: 4px; max-width: 90%; truncate; }
        
        /* Drag & Drop Visuals */
        .draggable-item { cursor: grab; }
        .draggable-item:active { cursor: grabbing; }
        .drag-over { border-top: 2px solid #3b82f6 !important; background: #eff6ff !important; }
        .dragging { opacity: 0.5; }

        #modal-root.active, #confirm-root.active { display: flex; animation: fadeIn 0.15s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col p-4 overflow-hidden">

    <!-- Header -->
    <div class="bg-white px-6 py-3 rounded-xl shadow-sm border border-slate-200 mb-4 flex flex-col md:flex-row gap-4 justify-between items-center flex-shrink-0 z-[60]">
        <div>
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2"><i data-lucide="layout-list" class="text-indigo-600"></i> Timeline Master</h1>
            <div class="flex gap-4 text-xs font-medium text-slate-500 mt-1"><span id="stat-projects">...</span><span id="stat-progress" class="text-emerald-600 font-bold bg-emerald-50 px-2 py-0.5 rounded">0% Done</span></div>
        </div>
        <div class="flex gap-2 items-center">
            <select id="project-filter" onchange="App.setFilter(this.value)" class="bg-slate-50 border border-slate-300 text-sm rounded-lg px-3 py-1.5 outline-none"><option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
            <button onclick="App.fitView()" class="px-3 py-1.5 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-600 hover:bg-slate-50 flex gap-2"><i data-lucide="maximize" class="w-4 h-4"></i> Fit</button>
            <button onclick="App.openProjectForm()" class="px-3 py-1.5 bg-white border border-slate-300 rounded-lg text-sm font-bold text-indigo-600 hover:bg-indigo-50 flex gap-2"><i data-lucide="folder-plus" class="w-4 h-4"></i> ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</button>
            <button onclick="App.openTaskForm()" class="px-4 py-1.5 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 shadow flex gap-2"><i data-lucide="plus" class="w-4 h-4"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
        </div>
    </div>

    <!-- Timeline -->
    <div class="flex-1 bg-white rounded-xl shadow border border-slate-200 overflow-hidden relative flex flex-col">
        <div id="timeline-container" class="timeline-wrapper"></div>
    </div>

    <!-- Modals -->
    <div id="modal-root" class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center p-4"></div>
    <div id="confirm-root" class="fixed inset-0 z-[110] bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden p-6 text-center">
            <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="alert-triangle" class="w-6 h-6"></i></div>
            <h3 class="text-lg font-bold text-slate-800 mb-2" id="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>
            <p class="text-slate-500 text-sm mb-6" id="confirm-msg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£</p>
            <div class="flex gap-3">
                <button onclick="App.closeConfirm()" class="flex-1 py-2 bg-slate-100 text-slate-700 rounded-lg font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-btn-yes" class="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold shadow">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö</button>
            </div>
        </div>
    </div>

    <script>
        const INP_CLS = "w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none";
        const App = {
            state: { projects: [], tasks: [], filterId: 'all', view: { start: new Date(), end: new Date(), colW: 70 }, drag: { type: null, srcId: null } },

            init() {
                this.state.projects = Core.Storage.get('myProjectsV5', [{id: 'default', title: '‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', color: '#64748b'}]);
                this.state.tasks = Core.Storage.get('myTasksV5', []);
                this.fitView();
            },

            save() {
                Core.Storage.set('myTasksV5', this.state.tasks, 'data_updated');
                Core.Storage.set('myProjectsV5', this.state.projects);
                this.render();
            },

            setFilter(id) { this.state.filterId = id; this.render(); },

            fitView() {
                const tasks = this.state.tasks;
                const now = new Date();
                if (tasks.length === 0) {
                    this.state.view.start = new Date(now.setDate(now.getDate() - 3));
                    this.state.view.end = new Date(now.setDate(now.getDate() + 10));
                } else {
                    let min = Infinity, max = -Infinity;
                    tasks.forEach(t => { if(!t.isRoutine) [t.planStart, t.planEnd].forEach(d => { if(d) { const time = new Date(d).getTime(); if(!isNaN(time)) { min=Math.min(min, time); max=Math.max(max, time); } } }); });
                    this.state.view.start = new Date((min === Infinity ? Date.now() : min) - (2 * 86400000));
                    this.state.view.end = new Date((max === -Infinity ? Date.now() : max) + (7 * 86400000));
                }
                this.render();
            },

            // --- Drag & Drop ---
            handleDragStart(e, type, id) {
                this.state.drag = { type, srcId: id };
                e.dataTransfer.effectAllowed = 'move';
                e.target.classList.add('dragging');
            },
            handleDragOver(e, type) {
                if (this.state.drag.type === type) {
                    e.preventDefault();
                    e.currentTarget.classList.add('drag-over');
                }
            },
            handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); },
            handleDrop(e, targetId) {
                e.preventDefault();
                e.currentTarget.classList.remove('drag-over');
                const { type, srcId } = this.state.drag;
                if (srcId == targetId) return;

                if (type === 'project') {
                    const idxSrc = this.state.projects.findIndex(p => p.id == srcId);
                    const idxDest = this.state.projects.findIndex(p => p.id == targetId);
                    if (idxSrc > -1 && idxDest > -1) {
                        const [moved] = this.state.projects.splice(idxSrc, 1);
                        this.state.projects.splice(idxDest, 0, moved);
                        this.save();
                    }
                } else if (type === 'task') {
                    // Reorder tasks 
                    const taskSrc = this.state.tasks.find(t => t.id == srcId);
                    const idxSrc = this.state.tasks.indexOf(taskSrc);
                    const idxDest = this.state.tasks.findIndex(t => t.id == targetId);
                    
                    if (idxSrc > -1 && idxDest > -1) {
                         const [moved] = this.state.tasks.splice(idxSrc, 1);
                         // If dropped on a task in a different project, adopt that project ID
                         const targetTask = this.state.tasks[idxDest > idxSrc ? idxDest - 1 : idxDest]; 
                         if(targetTask) moved.projectId = targetTask.projectId;
                         
                         this.state.tasks.splice(idxDest, 0, moved);
                         this.save();
                    }
                }
                e.target.classList.remove('dragging');
                this.state.drag = { type: null, srcId: null };
            },

            // --- CRUD ---
            openTaskForm(taskId = null, projectId = null) {
                const today = Core.Util.todayISO();
                // Safe default project fallback
                const defaultProjId = this.state.projects.length > 0 ? this.state.projects[0].id : 'default';
                const task = taskId ? this.state.tasks.find(t => t.id === taskId) : {
                    id: Core.Util.generateId(), title: '', projectId: projectId || defaultProjId, status: 'todo', remark: '',
                    planStart: today, planEnd: today, planTime: 'am', planEndTime: 'pm', actualStart: '', actualEnd: '', actualTime: 'am', actualEndTime: 'pm', isRoutine: false
                };
                this.renderModal('task', task);
            },
            openProjectForm(projId = null) {
                const proj = projId ? this.state.projects.find(p => p.id === projId) : { id: 'p_' + Core.Util.generateId(), title: '', color: '#3b82f6' };
                this.renderModal('project', proj);
            },
            handleSave(type, data) {
                if(!data.title) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠');
                if(type === 'task') { const i = this.state.tasks.findIndex(t => t.id === data.id); if(i > -1) this.state.tasks[i] = data; else this.state.tasks.push(data); } 
                else { const i = this.state.projects.findIndex(p => p.id === data.id); if(i > -1) this.state.projects[i] = data; else this.state.projects.push(data); }
                document.getElementById('modal-root').classList.remove('active');
                this.save();
            },
            
            // --- Improved Delete with Safe Logic ---
            confirmDelete(type, id) {
                const modal = document.getElementById('confirm-root');
                modal.classList.add('active');
                document.getElementById('confirm-msg').innerText = type === 'project' ? '‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö' : '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£';
                
                document.getElementById('confirm-btn-yes').onclick = () => {
                    if(type === 'task') {
                        this.state.tasks = this.state.tasks.filter(t => t.id !== id);
                    }
                    else {
                        // Unlocked: Allow delete ANY project as long as 1 remains
                        if (this.state.projects.length <= 1) return alert('‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠');
                        
                        // Safe Delete: Move tasks to the first available project instead of deleting them
                        const projectToDelete = id;
                        this.state.projects = this.state.projects.filter(p => p.id !== id);
                        
                        const safeProject = this.state.projects[0]; // Fallback project
                        if (safeProject) {
                            let movedCount = 0;
                            this.state.tasks.forEach(t => {
                                if(t.projectId === projectToDelete) {
                                    t.projectId = safeProject.id;
                                    movedCount++;
                                }
                            });
                            if(movedCount > 0) alert(`‡∏¢‡πâ‡∏≤‡∏¢ ${movedCount} ‡∏á‡∏≤‡∏ô ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "${safeProject.title}" ‡πÅ‡∏•‡πâ‡∏ß`);
                        } else {
                            // If somehow no project left (should be caught by check above), delete tasks
                            this.state.tasks = this.state.tasks.filter(t => t.projectId !== id);
                        }
                    }
                    this.closeConfirm();
                    this.save();
                };
            },
            closeConfirm() { document.getElementById('confirm-root').classList.remove('active'); },

            render() {
                const st = this.state;
                const viewStart = new Date(st.view.start); viewStart.setHours(0,0,0,0);
                const daysDiff = Math.ceil((st.view.end - viewStart) / 86400000) + 1;
                const colW = st.view.colW; const totalW = daysDiff * colW;

                document.getElementById('stat-projects').innerText = `${st.projects.length} ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠`;
                document.getElementById('stat-progress').innerText = `${st.tasks.length ? Math.round((st.tasks.filter(t=>t.status==='done').length/st.tasks.length)*100) : 0}% Done`;
                document.getElementById('project-filter').innerHTML = `<option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + st.projects.map(p => `<option value="${p.id}" ${st.filterId===p.id?'selected':''}>${p.title}</option>`).join('');

                // 1. Header
                let headerCells = '', dayCells = '', timeCells = '', currentM = '', mW = 0;
                for(let i=0; i<daysDiff; i++) {
                    const d = new Date(viewStart); d.setDate(d.getDate() + i);
                    const mStr = d.toLocaleDateString('th-TH', {month:'short', year:'2-digit'});
                    if(mStr !== currentM) { if(currentM) headerCells += `<div class="flex items-center justify-center border-r border-slate-300 text-xs font-bold text-slate-600 bg-slate-100" style="width:${mW}px">${currentM}</div>`; currentM = mStr; mW = colW; } else mW += colW;
                    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                    dayCells += `<div class="flex flex-col items-center justify-center border-r border-b border-slate-300 ${isWeekend?'bg-slate-100':'bg-white'}" style="width:${colW}px; height: 35px;"><span class="text-[9px] text-slate-500 leading-none mb-0.5">${d.toLocaleDateString('th-TH', {weekday:'short'})}</span><span class="text-sm font-bold text-slate-800 leading-none">${d.getDate()}</span></div>`;
                    timeCells += `<div class="flex border-r border-b border-slate-300 bg-white" style="width:${colW}px; height: 25px;"><div class="w-1/2 flex items-center justify-center text-[9px] text-slate-400 border-r border-dashed border-slate-200">‡πÄ‡∏ä‡πâ‡∏≤</div><div class="w-1/2 flex items-center justify-center text-[9px] text-slate-400">‡∏ö‡πà‡∏≤‡∏¢</div></div>`;
                }
                headerCells += `<div class="flex items-center justify-center border-r border-slate-300 text-xs font-bold text-slate-600 bg-slate-100" style="width:${mW}px">${currentM}</div>`;

                // 2. Body
                let bodyHTML = '';
                const getPos = (dStr, tStr) => { if(!dStr) return null; const d = new Date(dStr); d.setHours(0,0,0,0); return ((d - viewStart) / 86400000 + (tStr === 'pm' ? 0.5 : 0)) * colW; };
                
                const visibleProjs = st.filterId === 'all' ? st.projects : st.projects.filter(p => p.id === st.filterId);
                visibleProjs.forEach(p => {
                    const tasks = st.tasks.filter(t => t.projectId === p.id);
                    bodyHTML += `
                    <div class="flex w-max relative mt-2 first:mt-0"
                         draggable="true" ondragstart="App.handleDragStart(event, 'project', '${p.id}')" ondragover="App.handleDragOver(event, 'project')" ondrop="App.handleDrop(event, '${p.id}')">
                        <div class="sticky-project flex flex-col justify-center gap-1 group draggable-item">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-2 font-bold text-sm text-slate-800 truncate cursor-move">
                                    <div class="w-3 h-3 rounded-full" style="background:${p.color}"></div><span class="truncate w-40">${p.title}</span>
                                </div>
                                <div class="flex gap-1 opacity-100">
                                    <button onclick="App.openTaskForm(null, '${p.id}')" class="p-1 hover:bg-green-100 text-green-600 rounded"><i data-lucide="plus" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="App.openProjectForm('${p.id}')" class="p-1 hover:bg-indigo-100 text-indigo-600 rounded"><i data-lucide="edit-2" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="App.confirmDelete('project','${p.id}')" class="p-1 hover:bg-red-100 text-red-500 rounded" title="‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"><i data-lucide="trash" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 border-b border-slate-300 bg-slate-100" style="min-width:${totalW}px"></div>
                    </div>`;

                    tasks.forEach(t => {
                        const pStart = getPos(t.planStart, t.planTime), pEnd = getPos(t.planEnd, t.planEndTime);
                        const pW = (pStart!==null && pEnd!==null) ? Math.max((pEnd-pStart)+(colW/2), colW/2) : 0;
                        const aStart = getPos(t.actualStart, t.actualTime), aEnd = getPos(t.actualEnd, t.actualEndTime);
                        const aW = (aStart!==null && aEnd!==null) ? Math.max((aEnd-aStart)+(colW/2), colW/2) : 0;
                        const statusColor = {'done':'#059669','delay':'#ef4444','in_progress':'#10b981'}[t.status] || '#94a3b8';

                        bodyHTML += `
                        <div class="flex w-max group hover:bg-indigo-50/30 transition-colors"
                             draggable="true" ondragstart="App.handleDragStart(event, 'task', ${t.id})" ondragover="App.handleDragOver(event, 'task')" ondrop="App.handleDrop(event, ${t.id})">
                            <div class="sticky-task p-2 border-b border-slate-200 draggable-item">
                                <div class="flex justify-between items-start cursor-pointer" onclick="App.openTaskForm(${t.id})">
                                    <div class="text-sm font-medium text-slate-700 leading-tight w-48 break-words group-hover:text-indigo-600 transition-colors"><i data-lucide="grip-vertical" class="w-3 h-3 inline text-slate-300 mr-1 cursor-grab"></i>${t.title}</div>
                                    <div class="w-20 text-[10px] text-white text-center rounded px-1 py-0.5" style="background:${statusColor}">${t.status}</div>
                                </div>
                                ${t.remark ? `<div class="remark-tag"><i data-lucide="file-text" class="w-3 h-3"></i> ${t.remark}</div>` : ''}
                            </div>
                            <div class="relative grid-bg border-b border-slate-200" style="min-width:${totalW}px; height: auto; min-height: 60px; background-size: ${colW}px 100%;">
                                <div class="absolute inset-0 pointer-events-none grid-ampm" style="background-size: ${colW}px 100%;"></div>
                                ${pW > 0 ? `<div class="absolute h-6 top-2 bg-slate-300 rounded-sm border border-slate-400 cursor-pointer hover:bg-slate-400 z-10" style="left:${pStart}px; width:${pW}px" onclick="App.openTaskForm(${t.id})"></div>` : ''}
                                ${aW > 0 ? `<div class="absolute h-6 top-9 rounded-sm shadow-sm cursor-pointer hover:brightness-110 z-20 flex items-center justify-center text-[9px] text-white font-bold" style="left:${aStart}px; width:${aW}px; background:${statusColor}" onclick="App.openTaskForm(${t.id})">${aW>30?(aW/colW).toFixed(1)+'d':''}</div>` : ''}
                            </div>
                        </div>`;
                    });
                });

                document.getElementById('timeline-container').innerHTML = `<div style="width:fit-content;min-width:100%"><div class="flex w-max sticky-header"><div class="sticky-corner text-sm">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏á‡∏≤‡∏ô</div><div class="flex flex-col"><div class="flex h-[25px] border-b border-slate-300 bg-slate-100">${headerCells}</div><div class="flex">${dayCells}</div><div class="flex">${timeCells}</div></div></div>${bodyHTML}<div class="absolute top-0 bottom-0 border-l-2 border-red-500 z-50 pointer-events-none dashed opacity-70" style="left: ${getPos(Core.Util.todayISO(), new Date().getHours()>=12?'pm':'am') + 300}px;"></div></div>`;
                lucide.createIcons();
            },

            renderModal(type, data) {
                const root = document.getElementById('modal-root'); root.classList.remove('hidden'); root.classList.add('active');
                
                if(type === 'task') {
                    root.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-[fadeIn_0.15s_ease-out]">
                        <div class="p-4 border-b bg-indigo-50 flex justify-between items-center"><h3 class="font-bold text-lg text-indigo-900">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô</h3><button onclick="document.getElementById('modal-root').classList.remove('active'); setTimeout(()=>document.getElementById('modal-root').classList.add('hidden'),150)" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button></div>
                        <div class="p-6 space-y-4 max-h-[75vh] overflow-y-auto">
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</label><input id="inp-title" class="${INP_CLS}" value="${data.title}"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label><select id="inp-proj" class="${INP_CLS}">${this.state.projects.map(p=>`<option value="${p.id}" ${data.projectId==p.id?'selected':''}>${p.title}</option>`).join('')}</select></div>
                                <div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select id="inp-status" class="${INP_CLS}">${['todo:‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°','start_plan:‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô','in_progress:‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥','holding:‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à','delay:‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤','done:‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'].map(s=>{const[v,l]=s.split(':'); return `<option value="${v}" ${data.status==v?'selected':''}>${l}</option>`}).join('')}</select></div>
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="inp-remark" class="${INP_CLS} h-24 resize-none">${data.remark||''}</textarea></div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200"><div class="text-xs font-bold text-slate-600 mb-3 border-b border-slate-200 pb-2">üìÖ ‡πÅ‡∏ú‡∏ô (Plan)</div><div class="flex gap-2 items-center mb-2"><span class="w-8 text-xs font-bold">‡πÄ‡∏£‡∏¥‡πà‡∏°:</span><input type="date" id="inp-pS" class="${INP_CLS} py-1" value="${data.planStart}"><select id="inp-pT" class="${INP_CLS} w-24 py-1"><option value="am" ${data.planTime=='am'?'selected':''}>‡πÄ‡∏ä‡πâ‡∏≤</option><option value="pm" ${data.planTime=='pm'?'selected':''}>‡∏ö‡πà‡∏≤‡∏¢</option></select></div><div class="flex gap-2 items-center"><span class="w-8 text-xs font-bold">‡∏à‡∏ö:</span><input type="date" id="inp-pE" class="${INP_CLS} py-1" value="${data.planEnd}"><select id="inp-pET" class="${INP_CLS} w-24 py-1"><option value="am" ${data.planEndTime=='am'?'selected':''}>‡πÄ‡∏ä‡πâ‡∏≤</option><option value="pm" ${data.planEndTime=='pm'?'selected':''}>‡∏ö‡πà‡∏≤‡∏¢</option></select></div></div>
                            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100"><div class="text-xs font-bold text-indigo-700 mb-3 border-b border-indigo-200 pb-2">üöÄ ‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á (Actual)</div><div class="flex gap-2 items-center mb-2"><span class="w-8 text-xs font-bold">‡πÄ‡∏£‡∏¥‡πà‡∏°:</span><input type="date" id="inp-aS" class="${INP_CLS} py-1 border-indigo-200" value="${data.actualStart}"><select id="inp-aT" class="${INP_CLS} w-24 py-1 border-indigo-200"><option value="am" ${data.actualTime=='am'?'selected':''}>‡πÄ‡∏ä‡πâ‡∏≤</option><option value="pm" ${data.actualTime=='pm'?'selected':''}>‡∏ö‡πà‡∏≤‡∏¢</option></select></div><div class="flex gap-2 items-center"><span class="w-8 text-xs font-bold">‡∏à‡∏ö:</span><input type="date" id="inp-aE" class="${INP_CLS} py-1 border-indigo-200" value="${data.actualEnd}"><select id="inp-aET" class="${INP_CLS} w-24 py-1 border-indigo-200"><option value="am" ${data.actualEndTime=='am'?'selected':''}>‡πÄ‡∏ä‡πâ‡∏≤</option><option value="pm" ${data.actualEndTime=='pm'?'selected':''}>‡∏ö‡πà‡∏≤‡∏¢</option></select></div></div>
                        </div>
                        <div class="p-4 border-t bg-slate-50 flex gap-3">
                            <button onclick="App.confirmDelete('task', ${data.id})" class="text-red-500 hover:text-red-700 font-bold text-sm px-4">‡∏•‡∏ö‡∏á‡∏≤‡∏ô</button>
                            <div class="flex-1"></div>
                            <button onclick="App.handleSave('task', {id: '${data.id}', title: document.getElementById('inp-title').value, projectId: document.getElementById('inp-proj').value, status: document.getElementById('inp-status').value, remark: document.getElementById('inp-remark').value, planStart: document.getElementById('inp-pS').value, planTime: document.getElementById('inp-pT').value, planEnd: document.getElementById('inp-pE').value, planEndTime: document.getElementById('inp-pET').value, actualStart: document.getElementById('inp-aS').value, actualTime: document.getElementById('inp-aT').value, actualEnd: document.getElementById('inp-aE').value, actualEndTime: document.getElementById('inp-aET').value})" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-indigo-700 shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        </div>
                    </div>`;
                } else {
                    root.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-[fadeIn_0.15s_ease-out]">
                        <div class="p-4 border-b bg-slate-50"><h3 class="font-bold text-lg text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</h3></div>
                        <div class="p-6 space-y-4"><div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label><input id="inp-ptitle" class="${INP_CLS}" value="${data.title}"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">‡∏™‡∏µ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</label><input type="color" id="inp-pcolor" class="w-full h-10 rounded cursor-pointer" value="${data.color}"></div></div>
                        <div class="p-4 border-t bg-slate-50 flex gap-3 justify-end"><button onclick="document.getElementById('modal-root').classList.remove('active'); setTimeout(()=>document.getElementById('modal-root').classList.add('hidden'),150)" class="px-4 py-2 rounded-lg border border-slate-300 bg-white text-slate-700 font-bold text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="App.handleSave('project', {id: '${data.id}', title: document.getElementById('inp-ptitle').value, color: document.getElementById('inp-pcolor').value})" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-indigo-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                    </div>`;
                }
                lucide.createIcons();
            }
        };
        window.onload = () => App.init();
    </script>
</body>
</html>